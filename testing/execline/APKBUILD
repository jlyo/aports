# Contributor: Jesse Young <jlyo@jlyo.org>
# Maintainer:
pkgname=execline
pkgver=1.3.1.1
pkgrel=1
pkgdesc="A (non-interactive) scripting language, like sh"
url="http://skarnet.org/software/execline/"
arch="all"
license="ISC"
depends="skalibs"
depends_dev="skalibs-dev"
makedepends="$depends_dev"
subpackages="$pkgname-dev $pkgname-doc"
source="http://skarnet.org/software/${pkgname}/${pkgname}-${pkgver}.tar.gz
        0001-Fix-broken-dynamic-library-symlinks.patch"

_builddir="${srcdir}/admin/${pkgname}-${pkgver}"

prepare() {
    cd "$_builddir"

	for i in $source; do
		case $i in
		*.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
		esac
	done

    echo /usr/lib/skalibs/sysdeps               > conf-compile/import

    echo "${CC} ${CFLAGS}"                      > conf-compile/conf-cc
    echo "${CC} ${LDFLAGS}"                     > conf-compile/conf-dynld
    echo "${CC} ${LDFLAGS}"                     > conf-compile/conf-ld

    echo "${pkgdir}/etc"                        > conf-compile/conf-etc
    echo "${pkgdir}/bin"                        > conf-compile/conf-install-command
    echo "${pkgdir}/usr/lib/${pkgname}"         > conf-compile/conf-install-library
    echo "${pkgdir}/lib"                        > conf-compile/conf-install-library.so
    echo "${pkgdir}/bin"                        > conf-compile/conf-install-libexec
    echo "${pkgdir}/usr/include/${pkgname}"     > conf-compile/conf-install-include
    echo "${pkgdir}/usr/share/man"              > conf-compile/conf-install-man
    echo "${pkgdir}/usr/share/doc/${pkgname}"   > conf-compile/conf-install-doc
    echo "${pkgdir}/usr/lib/${pkgname}/sysdeps" > conf-compile/conf-install-sysdeps

    echo                                        > conf-compile/conf-stripbins
    echo                                        > conf-compile/conf-striplibs

    echo /usr/include                           >  conf-compile/path-include
    echo /usr/include/skalibs                   >> conf-compile/path-include
    echo /usr/lib                               >  conf-compile/path-library
    echo /usr/lib/skalibs                       >> conf-compile/path-library
    echo /lib                                   >  conf-compile/path-library.so

    rm -f conf-compile/flag-slashpackage
    rm -f conf-compile/flag-allstatic

    echo -lstddjb >> src/libexecline/deps-lib/execline
}

build() {
    cd "$_builddir"

    make
}

package() {
    cd "$_builddir"
    make install

    install -dm755 "${pkgdir}/usr/share/doc/"
    cp -r doc "${pkgdir}/usr/share/doc/${pkgname}"
    install -D -m644 package/COPYING "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

dev() {
    mkdir -p "$subpkgdir"/usr
    mv "$pkgdir"/usr/include "$subpkgdir"/usr
    mv "$pkgdir"/usr/lib "$subpkgdir"/usr
}

md5sums="3913c1ef0b704703fac1271815651c8b  execline-1.3.1.1.tar.gz
496ba6a01a3b920cbf8427a6b0430ee0  0001-Fix-broken-dynamic-library-symlinks.patch"
sha256sums="efdb3292ac8dc48d2c42928aab5d3d171580fd92740434c95dd398e0e2c723af  execline-1.3.1.1.tar.gz
2131c457af4cd5d5460278cfe9a31543520871e4d3f740ae3def49607083a0ce  0001-Fix-broken-dynamic-library-symlinks.patch"
sha512sums="4a835863ada4667095283154b4ff036f4296042a6dfe1ce0b21786905150eabc6f71ab8413e0129326b11d923cf0f02fcfd8e200f0a70f86f7b76ea6aa7a89e3  execline-1.3.1.1.tar.gz
c7e0c441eca50eaa2ac7b635b55b237e6d3edca142b0b76d3a76606a7ce63e727c8d64eeb2df2618af41704395c12908d4c7d93e332bdcdb20127c55d0c1e5f2  0001-Fix-broken-dynamic-library-symlinks.patch"
